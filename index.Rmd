---
title: "practice_misc"
author: "ã‚„ã‚ã‚‰ã‹ã‚¯ã‚¸ãƒ©"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output:
  html_document: 
    toc: TRUE
    toc_float: true
    toc_depth: 4
    number_sections: true
    theme: readable
    highlight: pygments
    # css: custom.css
#mainfont: "Times New Roman"
editor_options: 
  chunk_output_type: console
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸èª­ã¿è¾¼ã¿

```{r}
library(tidyverse)
library(palmerpenguins)
library(janitor)
```

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å…¥ã£ã¦ãªã„å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦èª­ã¿è¾¼ã‚€å ´åˆï¼ˆã‚³ãƒ¼ãƒ‰ã®ã¿è¡¨ç¤ºï¼‰

* https://community.rstudio.com/t/is-it-a-good-idea-to-conditionally-load-install-libraries-at-the-beginning-of-a-script/15334/5

```{r eval = FALSE}
if (!require("palmerpenguins")) {
   install.packages("palmerpenguins")
   library(palmerpenguins)
}
```


# githubé€£æº

## githubã®ãƒ¬ãƒã‚¸ãƒˆãƒªã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä½œæˆã—ã¦ç®¡ç†

-   githubä¸Šã§`Code`\>`clone`ã§urlã‚’ã‚³ãƒ”ãƒ¼
-   RStudioã§`New Project`\>`Version Control`\>`Git`\>`Repositry URL` ã«urlè²¼ã‚Šä»˜ã‘ã¦`Create Project`


# ãƒ™ã‚¯ãƒˆãƒ«æ“ä½œ
## ä½œæˆã€€ 
```{r}
seq(1,3, by = 1)
seq(1,10, by = 2)
```

```{r}
rep(1, 3)
rep(1:3, 3)
rep(1:3, each = 3)
```

## è¦ç´ ã‚’å‰Šé™¤

* dplyr::setdiff

```{r}
abcd <- c("a", "b", "c", "d")
rmitem <- c("b", "c")

abcd |> 
  setdiff(rmitem)

```

* baseã®æ“ä½œ

```{r}
abcd [! abcd %in% rmitem]
```

```{r include=FALSE}
rm(abcd, rmitem)
```

## è¦ç´ ã®ã‚½ãƒ¼ãƒˆ
```{r}
sort(c("c", "a", "b"))
```



# æ­£è¦è¡¨ç¾

* regular expression (regexp)
* å‚ç…§
  + https://stringr.tidyverse.org/articles/regular-expressions.html

## æ•°å­—,æ–‡å­—
### ä¾‹ã®ä½œæˆ
```{r}
num <- c("1", "11", "111", "l", "|", "one", "ä¸€")
```

### æ•°å­— {.tabset}

* ã©ã‚Œã‚‚åŒã˜

#### ä¸€å­— {-}
```{r}
str_view(num, "[0-9]")
str_view(num, "[:digit:]")
str_view(num, "\\d")
```

#### ä¸‰å­— {-}
```{r}
str_view(num, "[0-9][0-9][0-9]")
```


### ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ {.tabset}
#### ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®ã¿ {-}
```{r}
str_view(num, "[a-z]")

```

#### æ—¥æœ¬èªã‚‚ {-}
```{r}
str_view(num, "[:alpha:]") # æ—¥æœ¬èªã‚‚å…¥ã‚‹
```

#### str_view_all {-}
```{r}
str_view_all(num, "[a-z]")
```


#### æ–‡å­—æ•°æŒ‡å®š {-}
```{r}
str_view(num, "[a-z][a-z][a-z]")
str_view(num, "[a-z]..")
str_view(num, "[a-z]{3}")

```



### æ•°å­—ã¨ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ {.tabset}
#### ä¸€æ–‡å­— {-}
```{r}
str_view(num, "[0-9a-z]")
```

#### ã™ã¹ã¦ {-}
```{r}
str_view_all(num, "[0-9a-z]")
```

#### æŒ‡å®šæ–‡å­—æ•° {-}
```{r}
str_view(num, "...")
```


## å˜èªã®ã¤ãªãŒã‚Š
### ä¾‹ã®ä½œæˆ
```{r}
text <- c("test", "test_test", "test_test_test", "testtest", 
          "test_testtest", "testtest_test", "test_test_","teest_teest")
```

### ç¹°ã‚Šè¿”ã— {.tabset}
#### ä¸€å› {-}
```{r}
str_view(text, "(....)_\\1")
str_view(text, "(.+)_\\1")
str_view(text, "(....)\\1")
str_view(text, "(....)\\1_\\1")
```

#### äºŒå› {-}
```{r}
str_view(text, "(....)_\\1_\\1")
```


## åŒºåˆ†ã™ã‚‹ç‚¹ã‚’æ¢ã™

* å¤‰æ•°åã§pivot_longerã™ã‚‹ã¨ãã«

### æ¤œè¨ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ
```{r}
mtcars_vsam <- 
  mtcars |> 
  summarise(across(c(vs, am),
                   list(
                     p = \(x) mean(x, na.rm = TRUE),
                     n = \(x) sum(x, na.rm = TRUE),
               total_n = \(x) sum(!is.na(x))
                   ))
            )

mtcars_vsam

# purrr 1.0.0ã‚ˆã‚Šå‰
# mtcars_vsam <- 
#   mtcars |> 
#   summarise(across(c(vs, am),
#                    list(
#                      p = ~mean(., na.rm = TRUE),
#                      n = ~sum(., na.rm = TRUE),
#                total_n = ~sum(!is.na(.))
#                    ))
#             )
```

#### meanã¨sdã‚’åˆ—åã«ã™ã‚‹pivot_longer(Ã—ãªä¾‹)

* total_nã‚‚åˆ—åã«ã‚‚ã£ã¦ããŸã„

```{r}
mtcars_vsam |> 
  pivot_longer(everything(),
               names_to = c("items", ".value"),
               names_pattern = "(.*)_(.*)")
```


### å¤‰æ•°åã®æ–‡å­—ã®é•·ã•ç¢ºèª
```{r}

# é™é †ã«ä¸¦ã³æ›¿ãˆã¦1è¡Œç›®ã‚’å–å¾—
max_value <- 
names(mtcars_vsam) |>
  str_count() |>
  as_tibble() |>
  arrange(desc(value))

max_value

# æ–‡å­—æ•°ã®æœ€å¤§å€¤å–å¾—
max_value <- 
  max_value |> 
  slice(1)

# total_pã®å‰ã¾ã§ã§åˆ‡ã‚‹æƒ…å ±ã‚’è¿½åŠ ã—ãŸã„ãŸã‚ã€æœ€å¤§å€¤-total_pã®æ–‡å­—æ•°è¨ˆç®—

max_value - str_count("total_p")
```

#### meanã¨sdã‚’åˆ—åã«ã™ã‚‹pivot_longer(okãªä¾‹)

```{r}
mtcars_vsam |> 
  pivot_longer(everything(),
               names_to = c("items", ".value"),
               names_pattern = "(.{1,2})_(.+)") # _ã®å‰ã¯1ï½2å­—ã¾ã§ã«é™å®š
```

##### {n}ã®æŒ™å‹•  {.tabset}

https://r4ds.had.co.nz/strings.html#repetition

###### æ–‡å­— {-}
```{r}

str_view("xxxxx", ".{1}")
str_view("xxxxx", "x{3}")

x <- c("xx_xxx","x_xx_xxx_xxxx_xxxxx")

str_view(x, "x{2,4}")

str_view_all(x, "x{2,4}")
```

###### æ•°å­— {-}
```{r}
numbers <- 
  c("123", "123456", "123456789")

str_view(numbers, ".{4,}")
# str_view(numbers, ".{,9}")

str_view(numbers, ".{4,7}")

str_view(numbers, ".{4,7}?") # lazy

```


## é€£ç¶šé‡ã‚’2å€¤åŒ–ã—ã¦å‰²åˆã‚’å‡ºã—ã¦1ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«
### 2å€¤å¤‰æ•°ä½œæˆ
```{r}
df_peng <-
  penguins |>
  mutate(across(ends_with("mm"),
                list(m = \(x) if_else(x > mean(x, na.rm = TRUE),1,0)))
         )
```

### å‰²åˆã¨nã¨total_nã‚’ç®—å‡º
```{r}

df_peng_res <- 
df_peng |>
  summarise(across(ends_with("_m"),
                   list( p    = \(x) mean(x, na.rm = TRUE),
                         n    = \(x) sum(x, na.rm = TRUE),           # bill_length_mm_mãŒ1ã®n
                         total_n    = \(x) sum(!is.na(x))))  # bill_length_mm_mã®naä»¥å¤–ã®nï¼ˆtotalï¼‰
  )


# å¤‰æ•°åã®æ–‡å­—ã®é•·ã•ç¢ºèª
# é™é †ã«ä¸¦ã³æ›¿ãˆã¦1è¡Œç›®ã‚’å–å¾—
max_value <- 
names(df_peng_res) |>
  str_count() |>
  as_tibble() |>
  arrange(desc(value))

max_value

# æ–‡å­—æ•°ã®æœ€å¤§å€¤å–å¾—
max_value <- 
  max_value |> 
  slice(1)

# total_pã®å‰ã¾ã§ã§åˆ‡ã‚‹æƒ…å ±ã‚’è¿½åŠ ã—ãŸã„ãŸã‚ã€æœ€å¤§å€¤-total_pã®æ–‡å­—æ•°è¨ˆç®—

max_value - str_count("total_p")
```

### meanã¨sdã‚’åˆ—åã«ã™ã‚‹pivot_longer
```{r}
df_peng_res |> 
pivot_longer(everything(),
               names_to = c("items", ".value"),
               names_pattern = "(.{1,20})_(.+)") # _ã®å‰ã¯1ï½20å­—ã¾ã§ã«é™å®š
```

# åº¦æ•°åˆ†å¸ƒã¨ã‚¯ãƒ­ã‚¹è¡¨
## åº¦æ•°åˆ†å¸ƒ
```{r}
df <- tribble(~moji,
              "a",
              NA,
              "c",
              "a",
              "c",
              "a")
```

### æ–‡å­—å‹ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

```{r}
df |> count(moji)
df |> tabyl(moji)
```


#### NAå¤–ã—ã¦
```{r}
df |> 
  tabyl(moji, show_na = FALSE)
```

#### countã§%
```{r}
df |> 
  drop_na(moji) |> 
  count(moji) |> 
  mutate(percent = n/sum(n))
```


### å› å­å‹

* æœ¬å½“ã¯ã‚«ãƒ†ã‚´ãƒª"b"ãŒã‚ã‚‹ãŒãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ãªã„ã“ã¨ã‚’ç¤ºã™

```{r}
df <- 
  df |> 
  mutate(moji = factor(moji, levels = c("a", "b", "c")))

df |> count(moji)
df |> tabyl(moji)
```

#### countã§ãƒ‡ãƒ¼ã‚¿ã®ãªã„æ°´æº–ã‚‚n=0ã§ç¤ºã™
```{r}
df |> count(moji, .drop = FALSE)

```


#### tabylã§ãƒ‡ãƒ¼ã‚¿ã®ãªã„æ°´æº–ã‚‚n=0ã§ç¤ºã—ã¦NAã¯è¨ˆç®—ã«å…¥ã‚Œãštotalã‚‚ç¤ºã™
```{r}
df |> 
  tabyl(moji, show_na = FALSE) |> 
  adorn_totals()
```

### æ•°å­—
```{r}
df <- tibble(suji = c(1,1,0,0,0,NA))

df |> tabyl(suji)

df |> 
  summarise(percent = mean(suji, na.rm = TRUE),
            n = sum(suji, na.rm = TRUE),
            total_n = sum(!is.na(suji)))

```

## ã‚¯ãƒ­ã‚¹è¡¨

### count
```{r}
mtcars |> 
  count(gear, vs)
```

* https://stackoverflow.com/questions/66820423/r-how-to-find-the-ratio-when-using-dplyr
* https://stackoverflow.com/questions/24576515/relative-frequencies-proportions-with-dplyr

#### å‰²åˆè¿½åŠ 

* gearã®æ°´æº–åˆ¥ã®vsã®å‰²åˆ(%)

```{r}
mtcars |> 
  count(gear, vs) |> 
  group_by(gear) |> 
  mutate(perc = n/sum(n)*100)
```

### æ¬ æã‚ã‚‹å ´åˆ
```{r}
penguins |> 
  count(species, sex)
```
 
#### å‰²åˆè¿½åŠ 
##### æ¬ æã‚ã‚Š
```{r}
penguins |> 
  count(species, sex) |>
  group_by(species) |>
  mutate(perc = n/sum(n)*100)
```

##### æ¬ ædrop
```{r}
penguins |> 
  drop_na(species, sex) |> 
  count(species, sex) |>
  group_by(species) |>
  mutate(perc = n/sum(n)*100)
```



### tabyl
```{r}
mtcars |> 
  tabyl(gear, vs)
```

#### å‰²åˆ {.tabset}
```{r}
mtcars |> 
  tabyl(gear, vs) |> 
  adorn_percentages()
```

##### å‰²åˆã¨n {-}
```{r}
mtcars |> 
  tabyl(gear, vs) |> 
  adorn_percentages() |> 
  adorn_ns()
```

##### å‰²åˆï¼ˆ%ï¼‰ã¨n {-}

```{r}
mtcars |> 
  tabyl(gear, vs) |> 
  adorn_percentages() |> 
  adorn_pct_formatting() |> 
  adorn_ns()
```

##### nã¨å‰²åˆï¼ˆ%) {-}

```{r}
mtcars |> 
  tabyl(gear, vs) |> 
  adorn_percentages() |> 
  adorn_pct_formatting() |> 
  adorn_ns(position = "front")
```

### 3è¦å› ä»¥ä¸Š
```{r}
penguins |> 
  count(island, species, sex) |>
  group_by(island, species) |>
  mutate(perc = n/sum(n)*100)



# mtcars |> 
#   count(gear, vs, am) |> 
#   group_by(gear, vs) |> 
#   mutate(perc = n/sum(n)*100)
```



## modelsummary::datasummary()
```{r}
modelsummary::datasummary_crosstab(species ~ sex, data = penguins)
```


# é–¢æ•°

* https://dplyr.tidyverse.org/articles/programming.html
* {{}}(curly curly; doubled braces)ã«ã¤ã„ã¦
  + https://www.tidyverse.org/blog/2019/06/rlang-0-4-0/#a-simpler-interpolation-pattern-with-
  + https://stackoverflow.com/questions/44121728/programming-with-dplyr-using-string-as-input
  
* {{}}ã¨enquoã®ä½¿ã„ã‚ã‘
  + https://stackoverflow.com/questions/65627873/turn-a-dplyr-double-curly-braces-interpolation-into-a-string

## åŸºæœ¬
```{r}
test <- function(x){
  x + 1
  }

test(1)
```

```{r}
test_xy <- function(x,y){
  x + y
}

test_xy(1, 2)
```

* å¼ãŒ1è¡Œã ã‘ãªã‚‰`{}`ä¸è¦

```{r}
test_simple <- function(x) x + 1

test_simple(10)
```


### çœç•¥å½¢

* https://www.r-bloggers.com/2021/05/new-features-in-r-4-1-0/

```{r}
test_s <- \(x){
  x + 1
  }

test_s(100)
```

```{r}
test_xy_s <- \(x,y){
  x + y
}

test_xy_s(2,3)
```

### é–¢æ•°å†…ã§æ•°å€¤ã¾ãŸã¯æ–‡å­—

```{r}
test_num <- function(x){
  print(x)
} 

test_num(1)
```

```{r}
test_chr <- function(x){
  x2 <- deparse(substitute(x))
    print(x2)
} 

test_chr(1)
```



## ç„¡åé–¢æ•° anonymous function

* https://adv-r.hadley.nz/functions.html#exercises-14
* functionã®å®šç¾©éƒ¨åˆ†ã‚’`( )`ã§å›²ã‚€ã¨å®Ÿè¡Œã§ãã‚‹

```{r}
(function(x) x + 1)(1)
```

### ç„¡åé–¢æ•°ã®çœç•¥å½¢ï¼ˆR4.1ä»¥é™ï¼‰
```{r}
(\(x) x + 1)(1)

(\(x, y) x + y)(2,3)

```

#### `\`ï¼ˆãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼‰ã®è¡¨ç¤ºã«ã¤ã„ã¦

* ãƒ–ãƒ©ã‚¦ã‚¶ã§HTMLé–‹ã„ãŸã¨ãã«å††ãƒãƒ¼ã‚¯ï¿¥ï¼ˆæœ¬å½“ã¯åŠè§’ï¼‰ã«ãªã‚‹å ´åˆã¯ï¼Œãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã§å›ºå®šå¹…ãƒ•ã‚©ãƒ³ãƒˆã‚’è‹±èªã®ã‚‚ã®ã«å¤‰ãˆã‚‹ã¨è§£æ±º

* å…·ä½“çš„ã«ã¯ï¼ŒChromeã§`ä¸‰ç‚¹ãƒªãƒ¼ãƒ€ > è¨­å®š > ãƒ‡ã‚¶ã‚¤ãƒ³ > ãƒ•ã‚©ãƒ³ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º > å›ºå®šå¹…ãƒ•ã‚©ãƒ³ãƒˆ`ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§MS Gothicã«ãªã£ã¦ã„ã‚‹å ´åˆï¼ŒArialã¨ã‹Courier Newã«å¤‰ãˆã‚‹

## é–¢æ•°ã®ä¸­èº«ç¢ºèª

* å‚è€ƒ
  + https://contributor.r-project.org/rdevguide/FindSource.html#finding-r-source-code
  + https://stackoverflow.com/questions/11173683/how-can-i-read-the-source-code-for-an-r-function
  + https://stackoverflow.com/questions/19226816/how-can-i-view-the-source-code-for-a-function


* é–¢æ•°ã‚’()ã‚’ã¤ã‘ãšã«å…¥åŠ›ã—ã¦å®Ÿè¡Œ

```{r}
select
```

* `methods()`ã§èª¿ã¹ã‚‹ã¨ã„ãã¤ã‹å€™è£œãŒå‡ºã‚‹

```{r}
methods(select)
```

* å…ƒã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«`:::`(æ³¨ï¼šã‚³ãƒ­ãƒ³3ã¤)ã‚’ã¤ã‘ã¦methodsã§èª¿ã¹ãŸå¯¾è±¡ã‚’å…¥åŠ›ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨ã‚³ãƒ¼ãƒ‰ãŒç¢ºèªã§ãã‚‹


```{r}
dplyr:::select.data.frame
```

* ã¾ãŸã¯é–¢æ•°ã‚’ä½¿ã†ã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åãªã—ã§ã‚‚ã§ãã‚‹

```{r}
getAnywhere(select.data.frame)
```

  
## å¹³å‡å€¤ç®—å‡º
### å¹³å‡å€¤ã¨n
```{r}
mean_n <- 
  function(data, variable){
    data |> 
      summarise(across({{variable}},
                       list(mean = \(x) mean(x, na.rm = TRUE),
                            n    = \(x) sum(!is.na(x))))
                )
  }

mean_n(penguins, where(is.numeric))
```

#### 
```{r}
mean_ns <- 
  \(data, variable){
    data |> 
      summarise(across({{variable}},
                       list(mean = \(x) mean(x, na.rm = TRUE),
                            n    = \(x) sum(!is.na(x))))
                )
  }

mean_ns(penguins, where(is.numeric))
```


#### ç¢ºèª
```{r}
penguins |> 
      summarise(across(where(is.numeric),
                       list(mean = \(x) mean(x, na.rm = TRUE),
                            n    = \(x) sum(!is.na(x))))
                )
```


### å¹³å‡å€¤ã¨nã§åˆ—ã‚’meanã¨nã«
```{r}
cmean_n <- 
  function(data, variable){
    data |> 
      summarise(across({{variable}},
                       list(mean = \(x) mean(x, na.rm = TRUE),
                            n    = \(x) sum(!is.na(x))))
      ) |> 
      pivot_longer(everything(),
                   names_to = c("variables", ".value"), # ".value"ã®éƒ¨åˆ†ã‚’åˆ—åã«
                   names_pattern = "(.*)_(.*)")
  }

cmean_n(penguins, where(is.numeric))
```

#### ç¢ºèª
```{r}
penguins |> 
      summarise(across(where(is.numeric),
                       list(mean = \(x) mean(x, na.rm = TRUE),
                            n    = \(x) sum(!is.na(x))))
      ) |> 
      pivot_longer(everything(),
                   names_to = c("variables", ".value"), # ".value"ã®éƒ¨åˆ†ã‚’åˆ—åã«
                   names_pattern = "(.*)_(.*)")
```

### totalã¨groupã®å¹³å‡å€¤ã¨nã‚’ä¸€æ°—ã«ç®—å‡º

* https://community.rstudio.com/t/using-map-with-a-vector-of-variables-and-dplyr-programming/93088

* pickã‚’ä½¿ã†ç†ç”±
  - `across()`ã¯ãã®å¾Œã«é–¢æ•°ã‚’é©ç”¨ã™ã‚‹ä»•æ§˜ã ã‹ã‚‰ï¼Œãã†ã˜ã‚ƒãªã„å ´åˆã®ã‚ˆã‚Šã‚ˆã„é¸æŠè‚¢ã¨ã—ã¦
  - https://www.tidyverse.org/blog/2023/02/dplyr-1-1-0-pick-reframe-arrange/

```{r}
all_group = function(data, outcome_vars, group_vars = NULL) {
  data |> 
    group_by(pick({{group_vars}})) |> 
    summarise(across({{outcome_vars}}, 
                     list(mean = \(x) mean(x, na.rm = TRUE),
                          n    = \(x) sum(!is.na(x)))))
}

all_group(penguins, bill_length_mm)
all_group(penguins, bill_length_mm, species)


# dplyr 1.1.0ã‚ˆã‚Šå‰
#    group_by(across({{group_vars}})) |> 


```

#### ç¢ºèª
```{r}
penguins |> 
  summarise(across(bill_length_mm,
                   list(mean = \(x) mean(x, na.rm = TRUE),
                          n    = \(x) sum(!is.na(x)))))

penguins |> 
  group_by(species) |> 
  summarise(across(bill_length_mm,
                   list(mean = \(x) mean(x, na.rm = TRUE),
                          n    = \(x) sum(!is.na(x)))))
```


#### mapã§ãƒªã‚¹ãƒˆã«çµæœã‚’æ ¼ç´
```{r}
quos(NULL, species) |> 
  map( \(x) all_group(penguins, bill_length_mm, !!x))


quos(NULL, species, island, c(species, island)) |> 
  map( \(x) all_group(penguins, bill_length_mm, !!x))
```


#### 1ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«

```{r}
quos(NULL, species) |> 
  map( \(x) all_group(penguins, bill_length_mm, !!x)) |> 
  bind_rows()

# ã“ã¡ã‚‰ã§ã‚‚OK
# quos(NULL, species) |> 
#   map_dfr( \(x) all_group(penguins, bill_length_mm, !!x))
```


```{r}
quos(NULL, species, island, c(species, island)) |> 
  map(\(x) all_group(penguins, bill_length_mm, !!x)) |> 
  bind_rows()

# ã“ã¡ã‚‰ã§ã‚‚OK
# quos(NULL, species, island, c(species, island)) |> 
#   map_dfr( \(x) all_group(penguins, bill_length_mm, !!x))
```




## ã‚¯ãƒ­ã‚¹è¡¨
### è¤‡æ•°å±¤åˆ¥ã¨å˜ä¸€ã®ã‚¢ã‚¦ãƒˆã‚«ãƒ 
```{r}
nest_tabyl = function(df, outcome_var, nest_vars = NULL){
df |>
  nest(data = !c({{nest_vars}})) |>
    mutate(freq =
           map(data, \(x) tabyl(x, {{outcome_var}}))) |> # show_na = FALSEã§æ¬ æç„¡ã—ã®percentã®ã¿ç®—å‡º
  select(!data) |>
  unnest(cols = c(freq)) |>
  as_tibble()
}

# island x species
nest_tabyl(penguins, species, island)

# speciesã®ã¿
nest_tabyl(penguins, species)

# å‹•ã‹ãªã„
# nest_tabyl(penguins, c(species, island))


```

#### è¤‡æ•°å±¤åˆ¥
```{r}
# å±¤ï¼šå…¨ä½“ï¼Œisland
quos(NULL, island) |> 
  map( \(x) nest_tabyl(penguins, species, !!x))

# å±¤ï¼šå…¨ä½“ï¼Œisland, sex, island x sex
quos(NULL, island, sex, c(island, sex)) |> 
  map( \(x) nest_tabyl(penguins, species, !!x))
```


#### ç¢ºèª
```{r}
penguins |>
  nest(data = !c(island)) |>
    mutate(freq =
           map(data, \(x) tabyl(x, species))) |>
  select(!data) |>
  unnest(cols = c(freq)) |>
  as_tibble()
```


### å›ºå®šå±¤åˆ¥ã¨è¤‡æ•°ã®ã‚¢ã‚¦ãƒˆã‚«ãƒ 
```{r}
# ã‚¢ã‚¦ãƒˆã‚«ãƒ ï¼šspecies, islandï¼›å±¤ï¼šãªã—
quos(species, island) |> 
  map( \(x) nest_tabyl(penguins, !!x))


# æ–‡å­—ã§ã‚‚OK
vars <- c("species", "island")

vars |> 
  map( \(x) nest_tabyl(penguins, x)) # !!.xã§ã‚‚å‹•ã„ãŸ



# ã‚¢ã‚¦ãƒˆã‚«ãƒ ï¼šspecies, islandï¼›å±¤ï¼šsex
quos(species, island) |> 
  map( \(x) nest_tabyl(penguins, !!x, sex))


```


#### åŒã˜æ–‡å­—ã‚’å«ã‚€åˆ—åã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹

* ãã‚Œãã‚Œã®tabylçµæœã¯ã‚¢ã‚¦ãƒˆã‚«ãƒ å¤‰æ•°åã®åˆ—åãŒç•°ãªã‚‹
* å˜ç´”ã«bind_rowsã™ã‚‹ã¨å¤‰æ•°ååˆ—ãŒæ¨ªã«å¢—ãˆã¦ã„ã
* ãã‚Œã‚’å›é¿ã™ã‚‹ãŸã‚ï¼ŒtabylçµæœãŒå…¥ã£ãŸlistã«ï¼Œãã‚Œãã‚ŒåŒã˜åå‰ã«renamaeã—ã¦ã„ã

```{r}
library(psychTools) # bfiã®æ ¼ç´ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

ac <- 
  bfi |>
  select(A1,A2,C1,C2) |> 
  names()  

# ä¸Šã§å®šç¾©ã—ãŸå¤‰æ•°ã«ã¤ã„ã¦nest_tabylå®Ÿè¡Œ
ac_res <- 
map(all_of(ac), \(x) nest_tabyl(bfi, x, gender)) |> 
  set_names(ac) # å„è¦ç´ ã«é …ç›®åã®åå‰ã‚’è¨­å®š


# å„ãƒªã‚¹ãƒˆè¦ç´ ã®ä¸Šã‹ã‚‰3ã¤ã‚’è¡¨ç¤º
map(ac_res, \(x) head(x, 3))

# å„å¤‰æ•°åã‚’çµ±ä¸€ã—ãŸåå‰ã«rename
ac_res <- 
ac_res |> 
  map(\(x) rename_with(x,
                   \(x) "response",               # çµ±ä¸€åã‚’ã“ã“ã«
                   starts_with(c("A", "C")))
      )

# å„ãƒªã‚¹ãƒˆè¦ç´ ã®ä¸Šã‹ã‚‰3ã¤ã‚’è¡¨ç¤º
map(ac_res, \(x) head(x, 3))


# ç¸¦ã«é€£çµ
ac_res |> 
  bind_rows(.id = "items")
```


#### è¤‡æ•°å±¤ã‚’ã¿ã‚‹ãŸã‚mtcarsã§

```{r}

# ã‚¢ã‚¦ãƒˆã‚«ãƒ ï¼šcyl, gearï¼›å±¤ï¼švs
quos(cyl, gear) |> 
  map( \(x) nest_tabyl(mtcars, !!x, vs))

# ã‚¢ã‚¦ãƒˆã‚«ãƒ ï¼šcyl, gearï¼›å±¤ï¼švs x am
quos(cyl, gear) |> 
  map( \(x) nest_tabyl(mtcars, !!x, c(vs,am)))
```

### è¤‡æ•°å±¤åˆ¥ã¨è¤‡æ•°ã‚¢ã‚¦ãƒˆã‚«ãƒ 

```{r}

groups <- quos(NULL, NULL, vs, am)
outcomes <- quos(cyl, gear, cyl, gear) # å±¤åˆ¥ã¨æ•°ã‚’ãã‚ãˆã‚‹ãŸã‚å¯¾å¿œã™ã‚‹å¯¾è±¡ã‚’ç¹°ã‚Šè¿”ã™
  
  
map2(outcomes, groups,  \(x, y) nest_tabyl(mtcars, !!x, !!y))
```

#### ç¢ºèª
```{r}
tabyl(mtcars, vs, cyl) |> 
  adorn_percentages()
```



### æ¬ æãŒã‚ã‚‹å ´åˆ
```{r eval=FALSE, include=FALSE}

```



# rlangã«ã¤ã„ã¦
## curly-curly {{}}

* å¼•æ•°ã®æ–‡å­—ãã®ã¾ã¾ã ã‘ã ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ç‰¹åˆ¥ãªæŒ‡å®šãŒå¿…è¦
* {{}}æ¼”ç®—å­ã‚’ä½¿ãˆã°é–¢æ•°ã®ä¸­ã§ï¼Œãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®å¤‰æ•°åã‚’å…¥ã‚Œã‚‰ã‚Œã‚‹

* å‚ç…§
  + https://www.tidyverse.org/blog/2020/02/glue-strings-and-tidy-eval/
  + https://rlang.r-lib.org/reference/quasiquotation.html



### rlang 0.4.0ä»¥é™ã‹ã‚‰

* https://www.tidyverse.org/blog/2019/06/rlang-0-4-0/#a-simpler-interpolation-pattern-with-

```{r}
mean_by <- function(df, by, var){
df |> 
  group_by({{by}}) |> 
  summarise(mean = mean({{var}}, na.rm =  TRUE))
}

mean_by(penguins, species, bill_length_mm)
```

#### {{}}ã¯!!enquo()ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

* !!(bang-bang)
  + å˜ä¸€ã®ç’°å¢ƒå¤‰æ•°ï¼ˆ<-ã§ä½œã‚‰ã‚ŒãŸå¤‰æ•°ï¼‰ã‚’ä»£å…¥ã™ã‚‹å ´åˆã«ä½¿ã†
* enquo
  + defusingæ¼”ç®—å­
    - https://rlang.r-lib.org/reference/nse-defuse.html
  + baseé–¢æ•°ã§ã„ã†substitute() 
  + å¤ã„æƒ…å ±: https://tidyeval.tidyverse.org/sec-up-to-speed.html

```{r}
mean_by2 <- function(df, by, var){
df |> 
  group_by(!!enquo(by)) |> 
  summarise(mean = mean(!!enquo(var), na.rm =  TRUE))
}

mean_by2(penguins, species, bill_length_mm)
```

```{r eval=FALSE, include=FALSE}
# å‹•ã‹ãªã„
mean_by2sym <- function(df, by, var){
  sby <- sym(by)
  svar <- sym(var)
  
df |> 
  group_by(!!sby) |> 
  summarise(mean = mean(!!svar, na.rm =  TRUE))
}

mean_by2sym(penguins, species, bill_length_mm)
```


### ä½œæˆã™ã‚‹å¤‰æ•°åã«glueã‚’åˆ©ç”¨ã™ã‚‹

* `:=`ã¯ã‚»ã‚¤ã‚¦ãƒæ¼”ç®—å­ï¼ˆwalrus operatorï¼‰ã¨ã„ã†ã‚‰ã—ã„

```{r}
mean_by3 <- function(df, by, var, prefix = "mean"){
  df |>
    group_by({{ by }}) |>
    summarise("{prefix}_{{ var }}" := mean({{ var }}, na.rm = TRUE))
}

mean_by3(penguins, species, bill_length_mm, prefix = "mean")
```


# mapé–¢é€£
## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ å†…ã®è¤‡æ•°ã®å¤‰æ•°ã«ä¸€åº¦ã«é–¢æ•°ã‚’é©ç”¨

```{r}
# ä½¿ç”¨ã™ã‚‹å¤‰æ•°æ ¼ç´
vars <-
  mtcars |> 
  select(vs,am,gear) |> 
  names()

map(vars, \(x) count(mtcars, .data[[x]])) |> 
  set_names(vars)                             # listã®è¦ç´ åä»˜ä¸

# å‰²åˆã‚‚
map(vars, \(x) count(mtcars, .data[[x]])) |> 
  set_names(vars) |> 
map(\(x) mutate(x, percent = n/sum(n)))  
```

## ãƒªã‚¹ãƒˆã®å„è¦ç´ ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã§ç‰¹å®šã®å¤‰æ•°ã‚’rename
```{r}
# renameã—ãŸã„å¤‰æ•°ã®å‹ã‚’å› å­å‹ã«
mtcars_f <- 
  mtcars |> 
  mutate(across(all_of(vars),
                factor))

tables <- 
map(vars, \(x) count(mtcars_f, .data[[x]], .drop = FALSE)) |> 
  set_names(vars) |> 
map(\(x) mutate(x, percent = n/sum(n)))

# å„å¤‰æ•°ã«å¯¾ã—é–¢æ•°ã‚’é©ç”¨(tidyselect 1.2.0 >= ã§warningãŒå‡ºã‚‹ã‚ˆã†ã«)
# tables <- 
# map(vars, \(x) tabyl(mtcars_f, .data[[x]])) |> 
#   set_names(vars)

# å„å¤‰æ•°ã®tabylçµæœã§é€£ç•ªä½œæˆ
tables <- 
  map(tables, \(x) mutate(x, vid = row_number()))

# å„ãƒªã‚¹ãƒˆè¦ç´ ã®å¤‰æ•°åã®åˆ—åã«æ–‡å­—ã‚’è¿½åŠ 
tables <- 
tables |> 
    map(\(x) rename_with(x, 
                     \(y) str_c(y, "_test"),
                     starts_with("per")))

# purrr 1.0.0ã‚ˆã‚Šå‰
# tables <- 
#   tables |> 
#   map(~rename_with(., 
#                       ~ str_c(., "_test"),
#                       starts_with("per")))

# å„ãƒªã‚¹ãƒˆè¦ç´ ã®å¤‰æ•°åã®åˆ—ã‚’åŒã˜åå‰ã«
tables <- 
  tables |> 
  map(\(x) rename_with(x, 
                       ~ "levels",
                       where(is.factor)))

# purrr 1.0.0ã‚ˆã‚Šå‰
# tables <- 
#   tables |> 
#   map(~rename_with(., 
#                       ~ "levels",
#                       where(is.factor)))

bind_rows(tables, .id = "var_name")

```

## imap & rename_with

* https://stackoverflow.com/questions/61914847/replacing-dplyrfuns-within-imap-that-refers-to-the-y-value

```{r}
df_2020 <- tribble(
~id, ~var1, ~var2,
1, 1, 0,
2, 0, 1,
3, 1, 1
)

df_2021 <- tribble(
~id, ~var1, ~var2,
1, 0, 0,
2, 1, 0,
3, 1, 1
)

# ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ãƒªã‚¹ãƒˆã«ã¾ã¨ã‚ã¦è¦ç´ åã‚’ã¤ã‘ã‚‹
df_list <- 
  list(df_2020, df_2021) |> 
  set_names("y20", "y21")

# ãƒªã‚¹ãƒˆå†…ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®idä»¥å¤–ã®å¤‰æ•°ã«è¦ç´ åã®æ¥å°¾è¾ã‚’ã¤ã‘ã‚‹
df_list <- 
 imap(df_list,
       function(a,b){
         rename_with(a,
          \(x) {str_c(x, b, sep = "_")}, !id)}
      )

df_list

# ãƒªã‚¹ãƒˆå†…ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æ¨ªã«é€£çµ

df_list |>
  reduce(full_join, by = "id")

```

## å›å¸°ï¼šè¤‡æ•°ã®ã‚¢ã‚¦ãƒˆã‚«ãƒ ã«åŒã˜èª¬æ˜å¤‰æ•°
```{r}
# ã‚¢ã‚¦ãƒˆã‚«ãƒ å¤‰æ•°åæ ¼ç´
outcomes <- 
  penguins |> 
  select(ends_with("_mm")) |> 
  names()
  
# å›å¸°
res_l <- 
  str_c(outcomes, "~ species*sex") |>
  map(\(x) lm(as.formula(x), data = penguins)) |> 
  set_names(outcomes)

# çµæœã®è¦ç´„

  res_l |> 
  map(\(x) broom::tidy(x, conf.int = TRUE)) |> 
  bind_rows(.id = "outcome") |> 
    print(n = 18)
```


# è¦ç´„ã„ã‚ã„ã‚
## psych::describe

* æ•°å€¤ã®è¦ç´„ã«ã¯ä¾¿åˆ©

```{r}
psych::describe(penguins)
```

## skimr
### ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ãªã—
```{r}
library(skimr)

skim_without_charts(penguins) |> 
  as_tibble()

```

### å‹ã‚’é™å®š
```{r}
skim(penguins) |> 
yank("numeric") |> 
  as_tibble()
```

### nã‚’è¡¨ç¤º
```{r}
skimn <- skim_with(base = sfl(n = \(x) sum(!is.na(x))))

skimn(penguins)

```



### å±¤åˆ¥
```{r}
penguins |> 
  group_by(sex) |> 
  skim() |> 
  as_tibble()
```

#### å±¤åˆ¥ã«ç‰¹å®šã®å¤‰æ•°ã®å¹³å‡ã¨SD
```{r}
penguins |> 
  group_by(species, sex) |> 
  skim(bill_length_mm, bill_depth_mm) |> # selectã‚’å…ˆã«ã‚‚ã£ã¦ãã¦ã‚‚ã‚ˆã„
  as_tibble()
```

#### å±¤åˆ¥ã«nã‚’è¡¨ç¤º

* https://github.com/ropensci/skimr/issues/505

```{r}
my_skim <- skim_with(base = sfl(n = length))

penguins |> 
  group_by(species, sex) |> 
  my_skim(bill_length_mm) |>
  as_tibble()
```



### longã«
```{r}
to_long(penguins)
```

## Data Explorer

https://rpubs.com/mark_sch7/DataExplorerPackage

```{r}
# devtools::install_github("boxuancui/DataExplorer")
library(DataExplorer)
```

### ã‚°ãƒ©ãƒ• {.tabset}
#### é »åº¦ã®æ£’ã‚°ãƒ©ãƒ•
```{r}
plot_bar(penguins)
```

```{r eval=FALSE, include=FALSE}
plot_bar(penguins, with = )
```

#### ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
```{r}
plot_histogram(penguins)
```

# æ•°å­—
## eã®è¡¨è¨˜ã‚’æ•°å€¤ã«

* æµ®å‹•å°æ•°ç‚¹è¡¨è¨˜æ³• floating point expression ã‚ã‚‹ã„ã¯ï¼Œç§‘å­¦çš„è¡¨è¨˜æ³• scientific notation
  + http://aoki2.si.gunma-u.ac.jp/Hanasi/StatTalk/fudoushousuu.html

```{r}
bnum <- 10000000000

bnum

format(bnum, scientific = FALSE)
```

### è¨­å®šè‡ªä½“ã‚’å¤‰æ›´
```{r}
options(scipen=999)

bnum

# æˆ»ã™
options(scipen = 0)

bnum

```

## å°æ•°ç‚¹

### å››æ¨äº”å…¥ã®ãƒ«ãƒ¼ãƒ«

http://cse.naro.affrc.go.jp/takezawa/r-tips/r/37.html

```{r}
round(1.5)
round(2.5)
```


### åˆ‡ã‚Šæ¨ã¦ã¨åˆ‡ã‚Šä¸Šã’
```{r}
round(0.123456, 5) # æ™®é€šã®ä¸¸ã‚
round(0.123454, 5) # æ™®é€šã®ä¸¸ã‚


# library(plyr) # dplyrèª­ã‚“ã å¾Œã«èª­ã¿è¾¼ã‚€ã¨dplyrã®é–¢æ•°ã§å‹•ã‹ãªããªã‚‹ã®ãŒã‚ã‚‹ã®ã§èª­ã‚€ãªã‚‰tidyverseã®å…ˆã«
plyr::round_any(0.123456, 0.00001, floor)   # åˆ‡ã‚Šæ¨ã¦
plyr::round_any(0.123454, 0.00001, ceiling) # åˆ‡ã‚Šä¸Šã’
```

#### åˆ‡ã‚Šæ¨ã¦ã‚’truncã§å·¥å¤«ï¼ˆæ•´æ•°ã«ã—ã¦å‰²ã‚Šæˆ»ã™ï¼‰
```{r}

trunc(0.123456*10^5)/10^5
```

#### mutateã®ãªã‹ã§ä½¿ã†
```{r}
# å°æ•°ç¬¬2ä½ã¾ã§å‡ºã¦ã„ã‚‹å¤‰æ•°
mtcars |> 
  select(drat, wt)

# å¤‰æ•°ä¸Šæ›¸ã

```

##### å¤‰æ•°ä¸Šæ›¸ã
```{r}
mtcars |> 
  mutate(across(c(drat,wt),
                \(x) plyr::round_any(x, 0.1, floor))) |> 
  select(drat, wt) |> 
  head()

```

##### å¤‰æ•°è¿½åŠ 
```{r}
mtcars |> 
  select(drat, wt) |>
  mutate(across(c(drat,wt),
                list(fl = \(x) plyr::round_any(x, 0.1, floor)))) |> 
    head()

```

##### trunc
```{r}
mtcars |> 
  mutate(across(c(drat,wt),
                \(x) trunc(x*10)/10)) |> 
  select(drat, wt) |> 
  head()
```

# æ–‡å­—
## str_replace 

* ç½®æ›ã™ã‚‹æ–‡å­—å¯¾ã®ä¸€è¦§ã‚’åå‰ä»˜ããƒ™ã‚¯ãƒˆãƒ«ã§ä½œæˆ

```{r}
moji_vec <- 
 as.character(1:3) |>                 # ãƒ™ã‚¯ãƒˆãƒ«ã®å€¤: å¤‰æ›´å…ˆã®æ–‡å­—
  set_names(c("one", "two", "three")) # åå‰: å…ƒã®æ–‡å­—

moji_vec

x <- c("item_one", "item_two", "item_three", "item_two_three")
x

str_replace_all(x, 
            moji_vec)
```

## str_squish ãƒ†ã‚­ã‚¹ãƒˆä¸­ã®è¤‡æ•°ç©ºç™½ã‚’1ã¤ã«

* æ–‡å­—åˆ—ã®ä¸­ã«è¤‡æ•°ç©ºç™½ãŒã‚ã£ã¦ã‚‚1ã¤ã ã‘ã«ã™ã‚‹

```{r}

str_squish("ã‚ã€€ã„ã€€ã€€ã†ã€€ã€€ã€€ã€€ãˆã€€ã€€ã€€ã€€ã€€ã€€ã€€ãŠ")

```

## str_replace ç‰¹å®šã®æ–‡å­—åˆ—ä»¥é™ã‚’å‰Šé™¤

```{r}
word <- "ã“ã®ãƒ†ã‚­ã‚¹ãƒˆã‚ˆã‚Šå¾Œã‚’å‰Šé™¤"

str_replace("æ–‡å­—åˆ—ã€€ã“ã®ãƒ†ã‚­ã‚¹ãƒˆã‚ˆã‚Šå¾Œã‚’å‰Šé™¤ã€€ã€€å‰Šé™¤éƒ¨åˆ†",
           str_c(word, ".*"), word)
```


## å¤‰æ•°å, åˆ—å, column
### å‡ºåŠ›ã„ã‚ã„ã‚
#### ãã®ã¾ã¾æ–‡å­—ãƒ™ã‚¯ãƒˆãƒ«ã¨ã—ã¦
```{r}
vars <- 
  penguins |>
  names()

vars
```

#### æ–‡å­—ãƒ™ã‚¯ãƒˆãƒ«ã®å…¥åŠ›æ™‚ã®å½¢å¼ã¨ã—ã¦
```{r}
dput(vars)
```

[constructiveãƒ‘ãƒƒã‚±ãƒ¼ã‚¸](https://cynkra.github.io/constructive/)

```{r}
constructive::construct(vars)
```


#### 1ã¤ã®æ–‡å­—åˆ—ã¨ã—ã¦
```{r}
cat(vars)
```

#### " "ã§å›²ã¾ãªã„ãƒ™ã‚¯ãƒˆãƒ«ã¨ã—ã¦
```{r}
noquote(vars)
```


https://cynkra.github.io/constructive/

# list
## é•·ã•ã®é•ã†è¦ç´ ã‚’æŒã¤listã‚’2åˆ—ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«ã¾ã¨ã‚ã‚‹

* https://stackoverflow.com/questions/68855260/turn-a-list-with-elements-of-unequal-length-into-a-two-column-dataframe-in-r-dp

* è‰²ã€…æ–¹æ³•ãŒã‚ã‚‹ãŒutils::stack()ãŒæ—©ã„


```{r}

test_l <- 
  list(a = c(1,2),
       b = c(1,2,3),
       c = c(1,2,3,4))

stack(test_l)
```


# ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
## å·®åˆ†ã®ç¢ºèª

* joinã—ãŸå¾Œã«.xã¨.yã®æ¥å°¾è¾ãŒã¤ã„ãŸå¤‰æ•°ã®å·®åˆ†ä½œæˆ

### joinã™ã‚‹2ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ

```{r}
p1 <-
  penguins |>
    select(species, starts_with("bill")) |> 
    slice(1:3) |> 
    mutate(id = row_number())
  
p2 <-
  penguins |>
    select(species, starts_with("bill")) |> 
    slice(4:6) |> 
    mutate(id = row_number())
```

```{r}
p1_2 <-
  p1 |>
    left_join(p2, by = join_by(id, species))

p1_2
```



### é–¢æ•°ã‚’ä½œæˆã—ã¦å®Ÿè¡Œ

* å‚è€ƒï¼šhttps://github.com/tidyverse/dplyr/issues/4834

```{r}
  
# å¯¾è±¡ã¨ãªã‚‹å¤‰æ•°åã®ãƒ™ã‚¯ãƒˆãƒ«ä½œæˆ
var_name <- 
  penguins |>
    select(starts_with("bill")) |> 
    names()
  
  
# å·®åˆ†ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ä½œæˆ

make_dif <- function(df, var){
  df |>
    mutate("dif_,{var}" :=
             !!sym(str_c(var, ".x")) - !!sym(str_c(var, ".y"))
    )
}

make_dif2 <- function(df, var){
  df |>
    mutate("dif_{var}" := 
             !!sym(str_c(var, ".x")) - !!sym(str_c(var, ".y"))
    )
}

# å‹•ã
# make_dif <- function(df, var){
#     df |>
#       mutate(!!sym(str_c("dif_",{{var}})) :=
#                     !!sym(str_c(var, ".x")) - !!sym(str_c(var, ".y")))
#   }
# 
# make_dif2 <- function(df, var){
#     df |>
#       mutate("dif_{{var}}" := !!sym(str_c(var, ".x")) - !!sym(str_c(var, ".y")))
#   }

# å‹•ã
# make_dif <- function(df, var){
#     df |>
#       mutate(!!sym(str_c("dif_",{{var}})) :=
#                     !!sym(str_c({{var}}, ".x")) - !!sym(str_c({{var}}, ".y")))
#   }
# 
# make_dif2 <- function(df, var){
#     df |>
#       mutate("dif_{{var}}" := !!sym(str_c({{var}}, ".x")) - !!sym(str_c({{var}}, ".y")))
#   }

# å‹•ã
# make_di2 <- function(df, var){
# var1 <- sym(str_c({{var}}, ".x"))
# var2 <- sym(str_c({{var}}, ".y"))
#       df |>
#       mutate("dif_{{var}}" := !!var1 - !!var2)
#   }

# å‹•ã
# make_di2 <- function(df, var){
# var1 <- sym("{{var}}.x")
# var2 <- sym("{{var}}.y")
#       df |>
#       mutate("dif_{{var}}" := !!var1 - !!var2)
#   }


# å‹•ã‹ãªã„
# make_dif3 <- function(df, var){
# df |> 
#   mutate("dif_{{var}}" := !!sym("{{var}}.x") - !!sym("{{var}}.y"))
# }

# å‹•ã‹ãªã„
# make_dif3 <- function(df, var){
#   form <- "{{var}}.x - {{var}}.y"
# df |>
#   mutate("dif_{{var}}" := !! rlang::parse_expr(form) )
# }


  
p1_2 |>
  reduce(var_name, make_dif, .init = _) |> 
  select(id, species, contains("bill_length"), contains("bill_depth")) |> 
    glimpse()


p1_2 |>
  reduce(var_name, make_dif2, .init = _) |> 
  select(id, species, contains("bill_length"), contains("bill_depth")) |> 
    glimpse()


# p1_2 |>
#   reduce(var_name, make_dif3, .init = .) |>
#   select(id, species, contains("bill_length"), contains("bill_depth")) |>
#     glimpse()

```

### longã«ã—ã¦ã‹ã‚‰å·®åˆ†ä½œæˆ

* r-wakalangã§æ•™ãˆã¦ã‚‚ã‚‰ã£ãŸ
* ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ããªã‘ã‚Œã°ã“ã¡ã‚‰ã®æ–¹ãŒã‚·ãƒ³ãƒ—ãƒ«

```{r}
p1_long <- 
  pivot_longer(p1, !c(species, id), 
               values_to = "old")

p2_long <- 
  pivot_longer(p2, !c(species, id), 
               values_to = "new")

p1_2_long <-
  p1_long |>
    left_join(p2_long, by = c("id", "species", "name"))
  
p1_2_long |>
   mutate(diff = old - new) |>
    pivot_wider(
      names_from = name,
      values_from = old:diff,
      names_glue = "{name}_{.value}"
    )  |> 
  select(id, species, contains("bill_length"), contains("bill_depth")) |>   
    glimpse()
```

## å†ç¾å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ä¾‹ã®ä½œæˆ
```{r}
constructive::construct(penguins |> head(2))
```

```{r eval=FALSE, include=FALSE}
constructive::construct(penguins |> head(2),
                         opts_tbl_df("tribble"))
```

# ãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚º
## Rã§ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ¡ãƒ¢ãƒªé‡
```{r}
pryr::mem_used()
```

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚µã‚¤ã‚º
```{r}
test <- c(1:10000)
pryr::object_size(test)
```



# RCTã®è§£æ

* ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸HSAUR3ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

## ãƒ‡ãƒ¼ã‚¿
```{r}
btheb <- 
  HSAUR3::BtheB |> 
  clean_names() |>
  as_tibble()

# idä»˜ã‘ã‚‹
btheb <- 
  btheb |> 
  rowid_to_column(var = "id") 

btheb
```

## wideã‹ã‚‰longã«
```{r}
btheb_long <- 
  btheb |> 
  pivot_longer(!c(id:treatment),
               names_to = "time",
               names_prefix = "bdi_", # timeã®å€¤ã‹ã‚‰"bdi_"ã‚’å‰Šé™¤
               values_to = "bdi")

# timeã‚’factorã«ã—ã¦é †åºæŒ‡å®š
btheb_long <- 
  btheb_long |> 
  mutate(time = fct_relevel(time, "pre", "2m", "3m", "5m"))



btheb_long
```



## mixed model
### mixed modelã®è§£èª¬

* Brown, V. A. (2021). [An Introduction to Linear Mixed-Effects Modeling in R.](https://journals.sagepub.com/doi/full/10.1177/2515245920960351) Advances in Methods and Practices in Psychological Science, 4(1), 2515245920960351.

* [GLMM FAQ](http://bbolker.github.io/mixedmodels-misc/glmmFAQ.html)


### ãƒ¢ãƒ‡ãƒ«ä½œæˆã¨å®Ÿè¡Œ
```{r}
mm <- 
  lme4::lmer(bdi ~ treatment*time + (1 | id), 
             data = btheb_long)

summary(mm)

```


### tidyãªå‡ºåŠ›
```{r}
broom.mixed::tidy(mm, conf.int = TRUE)
```

### icc
```{r}
lme4::VarCorr(mm) |>
  as_tibble() |>
  mutate(icc = vcov/sum(vcov))
```


### ã‚°ãƒ©ãƒ•
```{r}
btheb_long |> 
    mutate(id = factor(id)) |> 
    filter(id %in% c(1:20)) |> # IDãŒ1~20ã¾ã§ã«é™å®š
ggplot(aes(time, bdi, 
           group = id)) + # color = id
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(size = 1) +
  theme_minimal() +
  facet_wrap(vars(treatment))

```


### å¯¾æ¯” contrast
```{r}
emmeans::emmeans(mm, specs = trt.vs.ctrl ~ time:treatment, adjust = "none")


# é‚ªé“ã ã‘ã©ï¼Œçµ¶å¯¾ã©ã†ã—ã¦ã‚‚på€¤ã‚’æ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆ
# lmerTest::lmer(bdi ~ treatment*time + (1 | id), 
#               data = btheb_long) |>
#   anova()

```




## cohen's d

* EMAtools::lme.dscore()
  + lmerTestã®çµæœã®tã¨dfã‹ã‚‰ç®—å‡º
  
$$
d =  \frac{2t}{\sqrt{df}}
$$

```{r eval=FALSE, include=FALSE}
 EMAtools::lme.dscore(mm, data = btheb_long, "lme4")
```


### æ‰‹å‹•ã§ç¢ºèª
```{r}
mmt <- 
  lmerTest::lmer(bdi ~ treatment*time + (1 | id), 
             data = btheb_long)

# äº¤äº’ä½œç”¨é …ã ã‘ã«
summary(mmt)$coefficients |> 
  as_tibble(rownames = "terms") |> 
  filter(terms == "treatmentBtheB:time8m")

```

*  `(2*-0.543)/sqrt(280)` = `r (2*-0.543)/sqrt(280)`



### å‚è€ƒï¼šé€šå¸¸ã®ç¾¤é–“ã®Cohen's d
#### å¹³å‡å€¤
```{r}
btheb |> 
  group_by(treatment) |> 
  summarise(mean = mean(bdi_8m, na.rm = TRUE),
            sd = sd(bdi_8m, na.rm = TRUE),
            n = sum(!is.na(bdi_8m)))
```

#### Cohen's d
##### compute.es
```{r}
compute.es::mes(13.6, 8.85, 11.5, 6.09, 25, 27)
```

##### effectsize
```{r}
effectsize::cohens_d(bdi_8m ~ treatment, data = btheb)
```


## Jacobson-Truax and reliable change indices

* Evans, C., Margison, F., & Barkham, M. (1998). [The contribution of reliable and clinically significant change methods to evidence-based mental health.](https://ebmh.bmj.com/content/1/3/70) Evidence-Based Mental Health, 1(3), 70-72.

* ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
  + https://github.com/AWKruijt/JT-RCI

* BDI-IIã®æƒ…å ±
  + å†æ¤œæŸ»ä¿¡é ¼æ€§:0.75
    - Erford, B. T., Johnson, E., & Bardoshi, G. (2016). Meta-analysis of the English version of the Beck depression inventoryâ€“second edition. Measurement and Evaluation in Counseling and Development, 49(1), 3-33.
  + å¹³å‡å€¤:13.7, SD:12.2
    - U.S. general population by Internet panel survey providers
    - Choi, S. W., Schalet, B., Cook, K. F., & Cella, D. (2014). [Establishing a common metric for depressive symptoms: linking the BDI-II, CES-D, and PHQ-9 to PROMIS depression](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5515387/). Psychological assessment, 26(2), 513â€“527. https://doi.org/10.1037/a0035768  


```{r}
# data.frameå‹ã«ã™ã‚‹å¿…è¦ã‚ã‚Š
btheb <- 
  btheb |> 
  as.data.frame()

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# devtools::install_github("AWKruijt/JT-RCI")

# jacobson & truaxã®reliable and clinically significant change
JTRCI::JTRCI(data = btheb, 
      pre = "bdi_pre", post = "bdi_8m",
      group = "treatment",
      reliability = .75,
      JTcrit = "C",
      normM = 13.7, normSD = 12.2 # å¥åº·ãªé›†å›£ã®å¹³å‡å€¤ã¨SD,
      # dysfM = , dysfSD = 
        )
```

### å€‹åˆ¥ã®çµæœã‚’è¡¨ç¤º

* preã¨postã§æ¬ æãŒãƒªã‚¹ãƒˆãƒ¯ã‚¤ã‚ºã•ã‚Œã¦ã‚‹ã“ã¨ã«æ³¨æ„
* RCI > 1.96ã€€ãŒã‚ˆã„
* RCI = change_abs/Sdiff 

```{r}
JTRCIdf |> head()
```

#### åˆ¥ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§RCIç®—å‡º

* `suddengains`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

```{r}
# ãƒ¡ã‚¿åˆ†æã«ã‚ˆã‚‹å†æ¤œæŸ»ä¿¡é ¼æ€§
test_retest_bdi <- 0.75

# 8mã®æ¬ æã‚’é™¤å¤–ã—ãŸtime1ã§ã®BDIã®SD
bdi_pre_sd <- 
  btheb |> 
  drop_na(bdi_8m) |> 
  summarise(sd(bdi_pre, na.rm = TRUE)) |> 
  pull()

# RCIç®—å‡º
suddengains::define_crit1_cutoff(sd = bdi_pre_sd,
                    reliability = test_retest_bdi)
```

#### RCIæ‰‹è¨ˆç®—
```{r}
# pre SD
bdi_pre_sd

# standard error
se_index <- 
bdi_pre_sd*sqrt(1-test_retest_bdi)
se_index

# standar error difference
se_d <- 
  sqrt(2*se_index^2)
se_d

# pre - postãŒæ¬¡ã®å€¤ã‚’è¶…ãˆã‚‹ã¨reliableãªå€¤

1.96*se_d

```


# csvèª­ã¿è¾¼ã¿
## åŸºæœ¬
```{r}
library(vroom)
vroom("data/penguins.csv")
```

## èª­ã¿è¾¼ã‚€å¤‰æ•°é¸æŠ
### åˆ—ã‚’ç‰¹å®š
```{r}
vroom("data/penguins.csv",
      col_select = c(species, sex))
```

### ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
```{r}
vroom("data/penguins.csv",
      col_select = starts_with("bill"))
```

### èª­ã¾ãªã„åˆ—
```{r}
vroom("data/penguins.csv",
      col_select = !c(species, island))
```

```{r}
vroom("data/penguins.csv",
      col_select = list(!c(starts_with("bill"), starts_with("s"))))
```

## èª­ã¿è¾¼ã‚€å‹ã‚’æŒ‡å®š
### å¤‰æ•°ã”ã¨ã«æŒ‡å®š

* å› å­å‹ "f"
* skip "_"
* æ–‡å­—å‹ "c"

```{r}
vroom("data/penguins.csv",
      col_types = c(species = "f", island = "_", bill_length_mm = "c"))
```

### ã™ã¹ã¦æ–‡å­—å‹ã§


```{r}
vroom("data/penguins.csv",
      col_types = c(.default = "c"))
```



# dplyrã‚ã‚Œã“ã‚Œ
## select
### å¤‰æ•°ã®ä¸¦ã³ã‚’ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹

* magrittr %>% ã˜ã‚ƒãªã„ã¨å‹•ã‹ãªã„

```{r}
df <- 
  tribble(~item10, ~item1, ~item100,  ~item5, ~id,
                10,     1,      100,       5,   1) # ãƒ‡ãƒ¼ã‚¿ã®å€¤ã«ç‰¹ã«æ„å‘³ã¯ãªã„

df %>% 
  select(sort(names(.)))
```

* ãŸã ã—ï¼Œæ•°å­—ã®ä¸¦ã³ã¯æ˜‡é †ã«ãªã‚‰ãªã„

### å¤‰æ•°ã®ä¸¦ã³ã‚’æ•°å­—é †ã«ã™ã‚‹
```{r}
df |> 
  select(id, num_range("item", 1:100))
```

## rowã”ã¨ã®å‡¦ç†

* https://dplyr.tidyverse.org/articles/rowwise.html

### ãã®ã¾ã¾
```{r}
df <- 
  tibble(a = c(1,  1,  1),
         b = c(NA, 2,  2),
         c = c(NA, NA, 3))

df |> 
  mutate(total = a + b + c)

df |> 
  mutate(total = sum(c(a, b, c), na.rm = TRUE))


df |> 
  mutate(mean_abc = mean(c(a,b,c), na.rm = TRUE))


# éNAã®6ã‚»ãƒ«ã§åˆè¨ˆ10ã‚’å‰²ã‚‹
10/6
```

### rowwise
#### sum
```{r}
df |> 
  rowwise() |> 
  mutate(total = sum(c(a, b, c), na.rm = TRUE))
```

#### mean
```{r}
df |> 
  rowwise() |> 
  mutate(mean_abc = mean(c(a, b, c), na.rm = TRUE))
```


#### selection helperã‚’ä½¿ã†
```{r}
df |> 
  rowwise() |> 
  mutate(mean_abc = mean(c_across(a:c), na.rm = TRUE))


df |> 
  rowwise() |> 
  mutate(mean_abc = mean(c_across(everything()), na.rm = TRUE))

```

### rowSumsã¨rowMean

* ã“ã£ã¡ã®æ–¹ãŒæ—©ã„

```{r}
df |> 
  mutate(total = rowSums(pick(a:c), na.rm = TRUE))

df |> 
  mutate(total = rowMeans(pick(a:c), na.rm = TRUE))


# dplyr < 1.1.0
# df |> 
#   mutate(total = rowSums(across(a:c), na.rm = TRUE))
# 
# df |> 
#   mutate(total = rowMeans(across(a:c), na.rm = TRUE))

```

## rename
### å¤‰æ›´å¯¾å¿œã®ãƒªã‚¹ãƒˆã‚’ä»£å…¥ã—ãŸã„æ™‚ã¯åå‰ä»˜ããƒ™ã‚¯ãƒˆãƒ«ã§
```{r}
old <- c("species", "island", "bill_length_mm")
new <- c("ç¨®", "å³¶", "ãã¡ã°ã—é•·ã•")
newvars <- setNames(old, new)

penguins |>
  rename(!!!newvars)

```

#### å¤‰æ›´å¯¾å¿œãƒªã‚¹ãƒˆãŒãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚ã‚‹ã¨ã
```{r}
rename_df <- tibble(
old = c("species", "island", "bill_length_mm"),
new = c("ç¨®", "å³¶", "ãã¡ã°ã—é•·ã•")
)

rename_df

rename_df |> 
  relocate(new) |> # newã‚’æœ€åˆã«ä¸¦ã¹æ›¿ãˆ
deframe()
```

## mutate


### case_whenã§å€¤ã§ã¯ãªãé–¢æ•°ã‚„å¼ã‚’æŒ‡å®šã™ã‚‹
```{r}
tribble(~a, ~b,
        0, 1,
        1, 2,
        2, 3) |> 
  mutate(b = case_when(a == 0 ~ (\(x) x+1)(b),
                       a == 1 ~ (\(x) x+2)(b),
                       .default = b)
  )
```

### å¯¾ç…§è¡¨ã‚’å…ƒã«å€¤ã‚’å¤‰æ›ã—ã¦ã„ã
#### case_whenã®å ´åˆ

- å¯¾ç…§è¡¨ãªã—

```{r}
penguins |> 
  mutate(speciesj = case_when(
                       species == "Adelie" ~ "ã‚¢ãƒ‡ãƒªãƒ¼",
                       species == "Chinstrap" ~ "ãƒ’ã‚²",
                       species == "Gentoo" ~ "ã‚¸ã‚§ãƒ³ãƒ„ãƒ¼",
                       .default = "ãã®ä»–"),
                       .keep = "used"
  ) |> 
  count(species, speciesj)

  
  
  # group_by(species) |> 
  # slice_head(n = 2)
```

#### case_matchã®å ´åˆ

- å¯¾ç…§è¡¨ãªã—

```{r}
penguins |> 
  mutate(speciesj = case_match(species,
                       "Adelie" ~ "ã‚¢ãƒ‡ãƒªãƒ¼",
                       "Chinstrap" ~ "ãƒ’ã‚²",
                       "Gentoo" ~ "ã‚¸ã‚§ãƒ³ãƒ„ãƒ¼",
                       .default = "ãã®ä»–"
                      ),
                       .keep = "used"
  ) |> 
  count(species, speciesj)

  
  
  # group_by(species) |> 
  # slice_head(n = 2)
```

#### left_joinã§ã‚‚ç½®ãæ›ãˆã¨åŒæ§˜ã®çµæœã‚’å¾—ã‚‰ã‚Œã‚‹

- å¯¾ç…§è¡¨ã‚ã‚Šã€‚å¤§é‡ã®ç½®ãæ›ãˆãªã‚‰ã“ã‚ŒãŒæœ€ã‚‚ãŠæ‰‹è»½ãªæ°—ãŒã™ã‚‹
  + reference table and left_join

```{r}
old <- 
  penguins |> 
  count(species) |> 
  pull(species)

new <- c("ã‚¢ãƒ‡ãƒªãƒ¼", "ãƒ’ã‚²",   "ã‚¸ã‚§ãƒ³ãƒ„ãƒ¼")

taisho <- 
  tibble(species = old,
         speciesj = new)

penguins |> 
  left_join(taisho) |> 
  count(species, speciesj)

```


#### åå‰ä»˜ããƒ™ã‚¯ãƒˆãƒ«ã§ç½®ãæ›ãˆ

- å¯¾ç…§è¡¨ã¯2ã¤ã®ãƒ™ã‚¯ãƒˆãƒ«
- https://gist.github.com/IndrajeetPatil/baff8cf625d9fcd5ef2a36f520373426
- https://www.r-bloggers.com/2018/01/recode-values-with-character-subsetting/

```{r}
new_old <- 
  new |>  
  set_names(old)

# ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œã‚‰ãšnewã‚’ä¸Šæ›¸ã
# names(new) <- old

penguins |> 
  mutate(speciesj = new_old[species]) |> 
  count(species, speciesj)
```


### è¤‡æ•°å›ç­”ãŒ1ã¤ã®åˆ—ã«ãƒ†ã‚­ã‚¹ãƒˆã§å…¥ã£ã¦ã„ã‚‹æ™‚ï¼Œå›ç­”åˆ¥ã®ãƒ•ãƒ©ã‚°åˆ—ã‚’ä½œæˆ
#### ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä½œæˆ
```{r}
# åŒºåˆ‡ã‚Šã«ã‚¹ãƒšãƒ¼ã‚¹ãªã—
df <- tribble(~id, ~multi_answer,
              1, "ã‚Šã‚“ã”,ã¿ã‹ã‚“,ã¶ã©ã†",
              2, "ã‚Šã‚“ã”,ã¶ã©ã†",
              3, "ãƒ¡ãƒ­ãƒ³,ã¶ã©ã†",
              4, "ã¶ã©ã†,ã‚Šã‚“ã”,ã¿ã‹ã‚“,ãƒ¡ãƒ­ãƒ³")

df


# ã‚¹ãƒšãƒ¼ã‚¹å…¥ã£ã¦ã„ã‚‹å ´åˆ
# tribble(~id, ~multi_answer,
#         1, "ã‚Šã‚“ã”, ã¿ã‹ã‚“, ã¶ã©ã†",
#         2, "ã‚Šã‚“ã”, ã¶ã©ã†",
#         3, "ãƒ¡ãƒ­ãƒ³, ã¶ã©ã†",
#         4, "ã¶ã©ã†, ã‚Šã‚“ã”, ã¿ã‹ã‚“, ãƒ¡ãƒ­ãƒ³") |> 
#   mutate(multi_answer = str_remove_all(multi_answer, " ")) # ã‚¹ãƒšãƒ¼ã‚¹é™¤å»


```
 
#### æ–‡å­—åˆ—ã‚’ãƒªã‚¹ãƒˆã«åˆ†å‰²ã—ã¦æ–°ã—ã„åˆ—ã«æ ¼ç´
```{r}
df <- 
  df |> 
  mutate(multi_answer_l = str_split(multi_answer, ",")) # åŒºåˆ‡ã‚Šã¯","

df
```
 
#### å„åˆ—ã«åˆ†å‰²
```{r}
df <- 
  df |> tidyr::hoist(multi_answer_l, 
             # åˆ—åæŒ‡å®š   
                     f1 = 1, 
                     f2 = 2, 
                     f3 = 3, 
                     f4 = 4) 

df


```

#### é¸æŠè‚¢ã”ã¨ã«ãƒ•ãƒ©ã‚°ã‚’è¡¨ã™åˆ—ã‚’è¿½åŠ   
```{r}

 df |> 
  mutate(ã‚Šã‚“ã” = case_when(f1 == "ã‚Šã‚“ã”" |
                            f2 == "ã‚Šã‚“ã”" |
                            f3 == "ã‚Šã‚“ã”" |
                            f4 == "ã‚Šã‚“ã”" ~ 1,
                                      TRUE ~ 0),
         ã¿ã‹ã‚“ = case_when(f1 == "ã¿ã‹ã‚“" |
                            f2 == "ã¿ã‹ã‚“" |
                            f3 == "ã¿ã‹ã‚“" |
                            f4 == "ã¿ã‹ã‚“" ~ 1,
                                      TRUE ~ 0),
         ã¶ã©ã† = case_when(f1 == "ã¶ã©ã†" |
                            f2 == "ã¶ã©ã†" |
                            f3 == "ã¶ã©ã†" |
                            f4 == "ã¶ã©ã†" ~ 1,
                                      TRUE ~ 0),
         ãƒ¡ãƒ­ãƒ³ = case_when(f1 == "ãƒ¡ãƒ­ãƒ³" |
                            f2 == "ãƒ¡ãƒ­ãƒ³" |
                            f3 == "ãƒ¡ãƒ­ãƒ³" |
                            f4 == "ãƒ¡ãƒ­ãƒ³" ~ 1,
                                      TRUE ~ 0)
  )
```

##### ã€åŠ¹ç‡åŒ–ã€‘
###### é–¢æ•°ä½œæˆ 
```{r}

# å›ç­”é¸æŠè‚¢ã”ã¨ã«åˆ—ã‚’ä½œã‚‹é–¢æ•°ä½œæˆ
multi_answer <- function(data, answer){
  data |> 
    mutate(!!sym({{answer}}) := case_when(f1 == answer |
                                  ã€€ã€€ã€€  f2 == answer |
                                  ã€€ã€€ã€€  f3 == answer |
                                  ã€€ã€€ã€€  f4 == answer ~ 1,
                                                ã€€TRUE ~ 0))
}


multi_answer(df, "ã‚Šã‚“ã”")


```

###### é–¢æ•°é©ç”¨ 
```{r}
multi_answer(df, "ã‚Šã‚“ã”") |> 
multi_answer("ã¿ã‹ã‚“") |> 
multi_answer("ã¶ã©ã†") |> 
multi_answer("ãƒ¡ãƒ­ãƒ³")  


```

##### ã€ã•ã‚‰ã«åŠ¹ç‡åŒ–ã€‘

```{r}

contents <- 
  c("ã‚Šã‚“ã”", "ã¿ã‹ã‚“", "ã¶ã©ã†", "ãƒ¡ãƒ­ãƒ³")

df_multi <- 
  map(contents, \(x) multi_answer(df, x)) |> 
  reduce(full_join)

df_multi
```

## acrosså‘¨ã‚Š

### ä½œæˆã™ã‚‹å¤‰æ•°ã®åå‰ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«

* `across()`ã®ä¸­ã§`.names =` å¼•æ•°ã‚’å…¥ã‚Œã‚‹ 

```{r}
penguins |> 
  summarise(across(c(bill_length_mm, bill_depth_mm),
                   list(
                     mean = \(x) mean(x, na.rm = TRUE),
                     n    = \(x) sum(!is.na(x))),
                   .names = "{.fn}_{.col}"
                   )
            
            )

```

```{r}

```

# tidyrã‚ã‚Œã“ã‚Œ
## pivot_wider
### åŸºæœ¬ {.tabset}
```{r}
mtcars |> 
  count(vs)

mtcars |> 
  count(vs) |> 
  pivot_wider(names_from = vs,
              values_from = n)

```

#### names_fromã«è¤‡æ•°åˆ—æŒ‡å®š {-}
```{r}
mtcars |> 
  count(vs) |> 
  mutate(name = "vs")

mtcars |> 
  count(vs) |>
  mutate(name = "vs") |> 
  pivot_wider(names_from = c(name,vs),
              values_from = n)

```

#### names_glue(namesã®å¤‰æ•°1ã¤) {-}
```{r}
mtcars |> 
  count(vs) |>
  pivot_wider(names_from = vs,
              names_glue ="{.value}_{.name}",
              values_from = n)

```

#### names_glue(namesã®åˆ—åæŒ‡å®š) {-}
```{r}
mtcars |> 
  count(vs) |>
  pivot_wider(names_from = vs,
              names_glue ="{.value}_{vs}",
              values_from = n)

```

#### names_glue(namesã®å¤‰æ•°2ã¤) {-}
```{r}
mtcars |> 
     count(vs) |>
     mutate(name = "vs") |> 
     pivot_wider(names_from = c(name,vs),
                 names_glue ="{.value}_{.name}",
                 values_from = n)
```



### (ğŸš§ä½œæˆä¸­)é–¢æ•°ã«ã—ã¦è¤‡æ•°å¤‰æ•°ã¸ã®é©ç”¨
```{r eval=FALSE, include=FALSE}

# ä½¿ç”¨ã™ã‚‹å¤‰æ•°æ ¼ç´
vars <-
  mtcars |> 
  select(vs,am) |> 
  names()

make_pw <- \(data, variable){

  variable_name <- deparse(substitute(variable))

  data |>
    count({{variable}}) |>
    # mutate(name = var_name) |>
    pivot_wider(names_from = {{variable}},
                names_glue = paste0("{.value}_", variable_name,  "_{.name}"), # {{variable}},
                values_from = n
                )
}

make_pw(mtcars, vs)


map(vars, \(x) make_pw(mtcars, .data[[x]]))

# çµæœãŒã“ã†ãªã‚‹
# [[1]]
# # A tibble: 1 Ã— 2
#   `n_.data[[x]]0` `n_.data[[x]]1`
#             <int>           <int>
# 1              18              14



# countçµæœã®ãƒªã‚¹ãƒˆä½œæˆ
mtcars_l <- 
  map(vars, \(x) count(mtcars, .data[[x]])) |> 
  set_names(vars)                             # listã®è¦ç´ åä»˜ä¸

mtcars_l

map(mtcars_l)
  


```


# å›å¸°
## ç·šå½¢
```{r}
res <- 
  lm(mpg ~ ., data = mtcars)

broom::tidy(res)
```

### æ¨™æº–åŒ–ä¿‚æ•°
```{r}
res2 <- 
  lm.beta::lm.beta(res)

broom::tidy(res2)
```

# ç›¸é–¢
## åŸºæœ¬

 * https://corrr.tidymodels.org/

```{r}
library(corrr)

mtcars |> 
  correlate()
```

### å¤‰æ•°çµã£ã¦è¡¨ç¤º
```{r}
mtcars |> 
  correlate() |> 
  focus(mpg, disp, wt, mirror = TRUE)
```

### ä¸‹å´ã®ã¿ã«
```{r}
mtcars |> 
  correlate() |> 
  focus(mpg, disp, wt, mirror = TRUE) |> 
  shave()
```

### ãƒšã‚¢ãƒ¯ã‚¤ã‚ºæ™‚ã®nã‚’ç®—å‡º
```{r}
psychTools::bfi |>
  select(A1,A2,C1,C2) |> 
  pair_n()

# ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«

psychTools::bfi |>
  select(A1,A2,C1,C2) |> 
  pair_n() |> 
  as_tibble()
```


## å±¤åˆ¥

* https://stackoverflow.com/questions/56243874/tidyverse-correlations-among-multiple-columns-grouped-by-other-column

```{r}
mtcars |>
  select(mpg, disp, wt, cyl) |>
  nest(data = !cyl) |>
  mutate(
    correlations = map(data, correlate)
  ) |>
  unnest(correlations)
```


### 1ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«
```{r}
mtcars |> 
  select(mpg, disp, wt, cyl) |> 
  group_by(cyl) |>
  group_modify(~ correlate(.x))

```

### listã®ã¾ã¾ã«ã—ã¦åŠ å·¥ã—ã¦ã‹ã‚‰1ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«
```{r}
# groupã«ã™ã‚‹å¤‰æ•°ã®æ°´æº–ã‚’æŠœãå‡ºã™
cyl_level <- 
mtcars |> 
  count(cyl) |> 
  pull(cyl)

mtcars |> 
  select(mpg, disp, wt, cyl) |> 
  group_by(cyl) |> 
  group_map(~ correlate(.)) |>  # ã“ã“ã¯æ—§è¡¨è¨˜ã˜ã‚ƒãªã„ã¨å‹•ã‹ãªã„
  map(\(x) shave(x)) |>         # ç›¸é–¢è¡Œåˆ—ã®ä¸Šå´ã‚’
  set_names(cyl_level) |>       # groupå¤‰æ•°ã®æ°´æº–ã‚’é©ç”¨
  bind_rows(.id = "cyl_level")
```


# æ™‚é–“æ¸¬å®š

## tictoc
```{r}

tictoc::tic()
# tic()ã¨toc()ã®é–“ã«å‡¦ç†ã‚’æŒŸã‚€
Sys.sleep(1) # 1ç§’å¾…ã¤
tictoc::toc()
```

### ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã¤ã‘ã¦ãƒ­ã‚°ã‚’æ®‹ã™
```{r}
tictoc::tic("1ç§’å¾…ã¤")
Sys.sleep(1)
tictoc::toc(log = TRUE)

tictoc::tic("2ç§’å¾…ã¤")
Sys.sleep(2)
tictoc::toc(log = TRUE)
```

#### ãƒ­ã‚°å‡ºåŠ›
```{r}
tictoc::tic.log() |> 
  unlist() |> 
  tibble()
```


# ã‚³ãƒ¼ãƒ‰ã®æ›¸å¼ä¿®æ­£

* `remedy`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚“ã å¾Œã«ä¿®æ­£ã—ãŸã„ç¯„å›²ã‚’æŒ‡å®šã—ä»¥ä¸‹ã‚’å®Ÿè¡Œ
  + `<-`  Addins > Align
  +  `=`  Addins > AlignEqual

* https://thinkr-open.github.io/remedy/index.html

******  
          
![](image/remedy.gif)      

```{r eval=FALSE, include=FALSE}
library(remedy)

# <- ã®ä½ç½®
test1 <- 1
test2<- 2
test10   <- 10

# ä¿®æ­£å¾Œ
test1    <- 1
test2    <- 2
test10   <- 10

# = ã®ä½ç½®
test1 = 1
test2= 2
test10   = 10

# ä¿®æ­£å¾Œ
test1    = 1
test2    = 2
test10   = 10


```

## é–¢é€£ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

* `ctrl + I` å†ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼ˆéšå±¤æ§‹é€ ã‚’ãã‚Œã„ã«ã™ã‚‹ï¼‰
* `ctrl + shift + A` å†ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆè¤‡æ•°è¡Œã«ã™ã‚‹ï¼‰

### ä¾‹ã€€
```{r eval = FALSE}
mtcars |>  
select(vs,am,gear) 



```



# å¼•ç”¨é–¢é€£

## Rã¨R Studioã¾ãŸã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å¼•ç”¨

* [Rã‚’å¼•ç”¨ã™ã‚‹](http://www.okadajp.org/RWiki/?R%E3%82%92%E5%BC%95%E7%94%A8%E3%81%99%E3%82%8B)(RjpWiki)
ã€€- `citation()`
* [Citing R](https://intro2r.com/citing-r.html)(An Introduction to R)
  - `citation("ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å")`
* [Citing RStudio](https://support.rstudio.com/hc/en-us/articles/206212048-Citing-RStudio)
  - `RStudio.Version()`

## R Studioã§ã®æ–‡çŒ®å¼•ç”¨

* [RStudio 1.4 Preview: Citations](https://www.rstudio.com/blog/rstudio-1-4-preview-citations/)

```{r}

```

# âœWebã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°

```{r eval=FALSE, include=FALSE}
# library(rvest)
# 
# res_table <- read_html()
# 
# table_list <- 
# res_table |> 
#   html_table()
# 
# res_table_list <- 
# table_list[[2]]
```

# R Markdown
## æ•°å¼
* [Mathematics in R Markdown](https://rpruim.github.io/s341/S19/from-class/MathinRmd.html)

## ãƒãƒ£ãƒ³ã‚¯ã®è‰²

* https://bookdown.org/yihui/rmarkdown-cookbook/chunk-styling.html

```{r class.source="bg-info"}
# {r class.source="bg-info"}
head(mtcars)
```

```{r class.source="bg-primary"}
# {r class.source="bg-primary"}
```

```{r class.source="bg-success"}
# {r class.source="bg-success"}
```

```{r class.source="bg-warning"}
# {r class.source="bg-warning"}
```

```{r class.source="bg-danger"}
# {r class.source="bg-danger"}
```

### å‡ºåŠ›ãƒãƒ£ãƒ³ã‚¯ã¨è‰²åˆ†ã‘
```{r class.source="bg-danger", class.output="bg-warning"}
# {r class.source="bg-danger", class.output="bg-warning"}

head(mtcars)
```


# Excelé–¢é€£
## openxlsx

* https://ycphs.github.io/openxlsx/index.html

```{r}
# ç©ºã®ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
library(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "ãƒšãƒ³ã‚®ãƒ³")
addWorksheet(wb, "ãƒšãƒ³ã‚®ãƒ³raw")

# ãƒ•ã‚©ãƒ³ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‹ã‚‰MS Pã‚´ã‚·ãƒƒã‚¯ã«å¤‰æ›´
modifyBaseFont(wb, "MS PGothic")

# ãƒ‡ãƒ¼ã‚¿ã‚’wbã«å…¥ã‚Œã‚‹
writeData(wb, sheet = "ãƒšãƒ³ã‚®ãƒ³", penguins, startCol = 1, startRow = 1)
writeData(wb, sheet = "ãƒšãƒ³ã‚®ãƒ³raw", penguins_raw, startCol = 1, startRow = 1)

# å…ˆé ­è¡ŒãŠã‚ˆã³å…ˆé ­åˆ—å›ºå®š
freezePane(wb, "ãƒšãƒ³ã‚®ãƒ³", firstRow = TRUE, firstCol = TRUE) 
freezePane(wb, "ãƒšãƒ³ã‚®ãƒ³raw", firstRow = TRUE, firstCol = TRUE)


# ä¿å­˜
saveWorkbook(wb, "out/penguins.xlsx", overwrite = TRUE)
```


# Rä»¥å¤–ã®é–¢é€£ãƒ¡ãƒ¢
## ç”»é¢ã®å‹•ç”»ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’gifãƒ•ã‚¡ã‚¤ãƒ«ã«

* å‹•ç”»ã ã‘ãªã‚‰windowsã‚­ãƒ¼ + G ã§ã‚‚ã§ãã‚‹
* ScreenToGifã‚’ä½¿ã†


